<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perimeter Park</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #8BC34A; /* Grass Green */
            background-image: 
                radial-gradient(#AED581 15%, transparent 16%),
                radial-gradient(#AED581 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            overflow: hidden;
            touch-action: manipulation;
        }

        .wood-panel {
            background-color: #8D6E63;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 8px);
            border: 4px solid #5D4037;
            box-shadow: 0 8px 0 #3E2723;
            border-radius: 12px;
        }

        .game-canvas {
            background-color: #C5E1A5;
            border: 4px solid #558B2F;
            border-radius: 16px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .btn-push {
            transition: all 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        .btn-push:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }

        .bounce {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* Number Keypad Styles */
        .keypad-btn {
            background-color: #FFECB3;
            color: #5D4037;
            font-weight: bold;
            font-size: 1.5rem;
            border: 2px solid #FFCA28;
            border-bottom: 5px solid #FFB300;
            border-radius: 10px;
            transition: all 0.1s;
        }
        .keypad-btn:active {
            transform: translateY(3px);
            border-bottom: 2px solid #FFB300;
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center p-4">

    <!-- Game Container -->
    <div class="max-w-4xl w-full h-full flex flex-col items-center justify-between relative">
        
        <!-- Header / Scoreboard -->
        <div class="w-full flex justify-between items-center mb-2 z-10">
            <div class="wood-panel px-4 py-2 text-white">
                <span class="text-yellow-200">Level:</span> <span id="level-display">1</span>
            </div>
            <h1 class="text-3xl md:text-5xl font-bold text-white drop-shadow-lg text-stroke text-center hidden md:block" style="-webkit-text-stroke: 2px #33691E;">Perimeter Park ü¶Å</h1>
            <div class="wood-panel px-4 py-2 text-white">
                <span class="text-yellow-200">Score:</span> <span id="score-display">0</span>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="relative w-full flex-grow flex flex-col items-center justify-center bg-white/30 backdrop-blur-sm rounded-2xl p-4 shadow-xl border-4 border-white/50">
            
            <!-- Canvas -->
            <canvas id="gameCanvas" class="game-canvas w-full h-full max-h-[50vh] md:max-h-[60vh] object-contain cursor-crosshair mb-4"></canvas>

            <!-- Question/Input Area -->
            <div class="w-full flex flex-col items-center justify-center space-y-2">
                <div class="bg-white rounded-xl px-6 py-2 shadow-md border-2 border-green-200">
                    <p class="text-green-800 text-lg md:text-xl font-bold text-center" id="question-text">
                        Calculate the Perimeter!
                    </p>
                </div>

                <!-- Input Display -->
                <div class="flex items-center space-x-2">
                    <span class="text-2xl font-bold text-white drop-shadow-md">Perimeter = </span>
                    <div id="input-display" class="bg-white w-32 h-12 rounded-lg border-4 border-blue-300 flex items-center justify-center text-2xl font-bold text-gray-700 shadow-inner">
                        ?
                    </div>
                </div>
            </div>

            <!-- Virtual Keypad (Mobile/Tablet friendly) -->
            <div class="w-full max-w-md mt-4 grid grid-cols-6 gap-2">
                <!-- Numbers 1-5 -->
                <button class="keypad-btn py-3" onclick="handleInput('1')">1</button>
                <button class="keypad-btn py-3" onclick="handleInput('2')">2</button>
                <button class="keypad-btn py-3" onclick="handleInput('3')">3</button>
                <button class="keypad-btn py-3" onclick="handleInput('4')">4</button>
                <button class="keypad-btn py-3" onclick="handleInput('5')">5</button>
                <button class="keypad-btn py-3 bg-red-200 border-red-300 text-red-800" onclick="handleInput('back')">‚å´</button>

                <!-- Numbers 6-0 -->
                <button class="keypad-btn py-3" onclick="handleInput('6')">6</button>
                <button class="keypad-btn py-3" onclick="handleInput('7')">7</button>
                <button class="keypad-btn py-3" onclick="handleInput('8')">8</button>
                <button class="keypad-btn py-3" onclick="handleInput('9')">9</button>
                <button class="keypad-btn py-3" onclick="handleInput('0')">0</button>
                <button class="keypad-btn py-3 bg-green-400 border-green-500 text-white" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <!-- Start Screen Overlay -->
    <div id="start-screen" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="wood-panel p-8 max-w-md text-center flex flex-col items-center animate-bounce-in">
            <h1 class="text-4xl font-bold text-white mb-4 drop-shadow-md">Perimeter Park üå≥</h1>
            <div class="text-6xl mb-4 bounce">ü¶Å</div>
            <p class="text-white text-lg mb-6 leading-relaxed">
                Welcome, Ranger! <br>
                The animals need new fences. <br>
                <span class="text-yellow-200 font-bold">Add the length of all sides</span> to find the perimeter and build the fence!
            </p>
            <button onclick="startGame()" class="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-3 px-8 rounded-full border-b-4 border-green-800 btn-push shadow-lg">
                Start Building!
            </button>
        </div>
    </div>

    <!-- Correct/Incorrect Overlay -->
    <div id="feedback-overlay" class="fixed inset-0 flex items-center justify-center z-40 pointer-events-none opacity-0 transition-opacity duration-300">
        <div id="feedback-content" class="transform scale-0 transition-transform duration-300 bg-white p-6 rounded-2xl shadow-2xl border-4 text-center">
            <div id="feedback-icon" class="text-6xl mb-2">üéâ</div>
            <h2 id="feedback-text" class="text-3xl font-bold">Great Job!</h2>
        </div>
    </div>

    <script>
        // --- Game State ---
        const animals = ['ü¶Å', 'üêØ', 'üêª', 'üêº', 'ü¶ä', 'üêÆ', 'üê∑', 'üê∏'];
        let score = 0;
        let level = 1;
        let isTutorial = false; // Added tutorial state
        let currentShape = null;
        let currentInput = "";
        let isAnimating = false;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const inputDisplay = document.getElementById('input-display');
        const scoreDisplay = document.getElementById('score-display');
        const levelDisplay = document.getElementById('level-display');

        // Resize handling
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            if(currentShape) drawShape(currentShape);
        }
        window.addEventListener('resize', resizeCanvas);

        // --- Game Logic ---

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            resizeCanvas();
            startTutorial(); // Start with tutorial instead of level 1
        }

        function startTutorial() {
            isTutorial = true;
            level = 0;
            score = 0;
            updateUI();
            levelDisplay.innerText = "Intro";
            
            // Fixed Tutorial Shape (Rectangle 4x3)
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            
            const widthVal = 4;
            const heightVal = 3;
            // Make it look nice and big
            const visualW = Math.min(w, h) * 0.5; 
            const visualH = visualW * 0.75;
            
            const points = [
                {x: cx - visualW/2, y: cy - visualH/2},
                {x: cx + visualW/2, y: cy - visualH/2},
                {x: cx + visualW/2, y: cy + visualH/2},
                {x: cx - visualW/2, y: cy + visualH/2}
            ];

            const sides = [
                {val: widthVal, x: cx, y: cy - visualH/2 - 25},
                {val: heightVal, x: cx + visualW/2 + 25, y: cy},
                {val: widthVal, x: cx, y: cy + visualH/2 + 25},
                {val: heightVal, x: cx - visualW/2 - 25, y: cy}
            ];

            currentShape = { 
                points, 
                sides, 
                correctPerimeter: 14, 
                animal: 'üéì' 
            };
            
            drawShape(currentShape);

            // Tutorial Instruction
            const qText = document.getElementById('question-text');
            qText.innerHTML = `
                <span class="block text-sm md:text-base text-gray-500 mb-1">Perimeter is the distance AROUND the shape.</span>
                <span class="block font-bold text-green-700">Add the sides: 4 + 3 + 4 + 3 = ?</span>
            `;
            qText.parentElement.classList.add('bg-yellow-50', 'border-yellow-400');
        }

        function nextLevel() {
            // Reset styles from tutorial
            const qText = document.getElementById('question-text');
            qText.innerText = "Calculate the Perimeter!";
            qText.parentElement.classList.remove('bg-yellow-50', 'border-yellow-400');

            currentInput = "";
            updateInputDisplay();
            generateShape();
            drawShape(currentShape);
        }

        function generateShape() {
            const margin = 80;
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            
            // Difficulty scaling
            let type = 'rect'; // Level 1 default
            let minVal = 1;
            let maxVal = 5;

            if (level > 2) { type = Math.random() > 0.5 ? 'triangle' : 'rect'; maxVal = 10; }
            if (level > 5) { type = Math.random() > 0.3 ? 'poly' : 'triangle'; maxVal = 12; }
            if (level > 8) { type = 'poly'; maxVal = 15; }

            // Generate Sides
            let sides = [];
            let points = [];
            let correctPerimeter = 0;
            const animal = animals[Math.floor(Math.random() * animals.length)];

            // Helper to generate reasonable integer sides
            const rand = () => Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;

            if (type === 'rect') {
                const widthVal = rand();
                const heightVal = rand();
                // Ensure it's not a square if we want variety, but squares are fine for grade 2
                
                const scale = Math.min(w, h) / (Math.max(widthVal, heightVal) * 3) * 0.8; // Scale to fit
                
                // Visual Dimensions (scaled but kept proportional-ish)
                // We use a fixed visual size base but scale slightly by value to show difference
                const visualW = 100 + (widthVal * 10);
                const visualH = 100 + (heightVal * 10);

                points = [
                    {x: cx - visualW/2, y: cy - visualH/2},
                    {x: cx + visualW/2, y: cy - visualH/2},
                    {x: cx + visualW/2, y: cy + visualH/2},
                    {x: cx - visualW/2, y: cy + visualH/2}
                ];

                // Rectangle sides: Top, Right, Bottom, Left
                sides = [
                    {val: widthVal, x: cx, y: cy - visualH/2 - 20},
                    {val: heightVal, x: cx + visualW/2 + 20, y: cy},
                    {val: widthVal, x: cx, y: cy + visualH/2 + 25},
                    {val: heightVal, x: cx - visualW/2 - 20, y: cy}
                ];
                correctPerimeter = (widthVal * 2) + (heightVal * 2);

            } else if (type === 'triangle') {
                const base = rand();
                const sideA = rand();
                const sideB = rand(); 
                // Ensure triangle inequality isn't completely broken visually, 
                // though for math problems we just show the numbers.
                // We'll draw an equilateral visual for simplicity but label it differently
                // or draw a generic isosceles.
                
                const size = Math.min(w, h) * 0.35;
                points = [
                    {x: cx, y: cy - size},
                    {x: cx + size, y: cy + size},
                    {x: cx - size, y: cy + size}
                ];

                sides = [
                    {val: sideA, x: cx + size/2 + 20, y: cy}, // Right
                    {val: base, x: cx, y: cy + size + 25},    // Bottom
                    {val: sideB, x: cx - size/2 - 20, y: cy}  // Left
                ];
                correctPerimeter = base + sideA + sideB;

            } else { // Irregular Quad / Polygon
                const s1 = rand();
                const s2 = rand();
                const s3 = rand();
                const s4 = rand();
                
                const size = Math.min(w, h) * 0.3;
                
                // Draw a trapezoid-ish shape
                points = [
                    {x: cx - size/2, y: cy - size},
                    {x: cx + size/2, y: cy - size},
                    {x: cx + size, y: cy + size},
                    {x: cx - size, y: cy + size}
                ];

                sides = [
                    {val: s1, x: cx, y: cy - size - 20}, // Top
                    {val: s2, x: cx + size*0.75 + 20, y: cy}, // Right
                    {val: s3, x: cx, y: cy + size + 25}, // Bottom
                    {val: s4, x: cx - size*0.75 - 20, y: cy} // Left
                ];
                correctPerimeter = s1 + s2 + s3 + s4;
            }

            currentShape = { points, sides, correctPerimeter, animal };
        }

        function drawShape(shape) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Fence Posts and Rails
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            // Fill (Grass inside)
            ctx.beginPath();
            ctx.moveTo(shape.points[0].x, shape.points[0].y);
            for(let i=1; i<shape.points.length; i++) {
                ctx.lineTo(shape.points[i].x, shape.points[i].y);
            }
            ctx.closePath();
            ctx.fillStyle = 'rgba(139, 195, 74, 0.3)';
            ctx.fill();

            // Draw Fence Rails (Wood color)
            ctx.beginPath();
            ctx.moveTo(shape.points[0].x, shape.points[0].y);
            for(let i=1; i<shape.points.length; i++) {
                ctx.lineTo(shape.points[i].x, shape.points[i].y);
            }
            ctx.closePath();
            ctx.lineWidth = 12;
            ctx.strokeStyle = '#8D6E63'; // Wood
            ctx.stroke();

            // Draw Inner Detail (Make it look like a fence)
            ctx.setLineDash([15, 10]);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#5D4037';
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw Posts at corners
            ctx.fillStyle = '#5D4037';
            shape.points.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw Animal in center
            ctx.font = '60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(shape.animal, canvas.width/2, canvas.height/2);

            // Draw Labels (Numbers)
            ctx.font = 'bold 28px Fredoka';
            ctx.fillStyle = '#33691E';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            
            shape.sides.forEach(side => {
                // Background bubble for number
                ctx.beginPath();
                ctx.arc(side.x, side.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = '#FFF9C4';
                ctx.fill();
                ctx.stroke(); // White border

                ctx.fillStyle = '#33691E';
                ctx.strokeText(side.val, side.x, side.y);
                ctx.fillText(side.val, side.x, side.y);
            });
        }

        // --- Interaction ---

        function handleInput(val) {
            if (isAnimating) return;

            if (val === 'back') {
                currentInput = currentInput.slice(0, -1);
            } else {
                if (currentInput.length < 4) {
                    currentInput += val;
                }
            }
            updateInputDisplay();
        }

        function updateInputDisplay() {
            inputDisplay.innerText = currentInput === "" ? "?" : currentInput;
            inputDisplay.style.color = currentInput === "" ? "#9CA3AF" : "#374151";
        }

        // Keyboard support
        window.addEventListener('keydown', (e) => {
            if (document.getElementById('start-screen').style.display !== 'none') return;
            
            if (e.key >= '0' && e.key <= '9') {
                handleInput(e.key);
            } else if (e.key === 'Backspace') {
                handleInput('back');
            } else if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        function checkAnswer() {
            if (isAnimating || currentInput === "") return;

            const userVal = parseInt(currentInput);
            if (userVal === currentShape.correctPerimeter) {
                handleCorrect();
            } else {
                handleIncorrect();
            }
        }

        function handleCorrect() {
            isAnimating = true;
            
            if (isTutorial) {
                // Tutorial Complete Logic
                isTutorial = false;
                score = 0;
                level = 1;
                
                playSound('win');
                createConfetti();
                
                // Custom feedback for tutorial
                const icon = document.getElementById('feedback-icon');
                const text = document.getElementById('feedback-text');
                icon.innerText = 'üéì';
                text.innerText = "You got it!";
                showFeedback(true);

                setTimeout(() => {
                    isAnimating = false;
                    updateUI();
                    nextLevel();
                }, 2500);
            } else {
                // Normal Gameplay Logic
                score += 10;
                level++;
                playSound('win');
                createConfetti();
                showFeedback(true);

                setTimeout(() => {
                    isAnimating = false;
                    updateUI();
                    nextLevel();
                }, 2000);
            }
        }

        function handleIncorrect() {
            playSound('lose');
            showFeedback(false);
            
            const display = document.getElementById('input-display');
            display.classList.add('shake');
            display.style.borderColor = '#EF4444'; // Red
            
            setTimeout(() => {
                display.classList.remove('shake');
                display.style.borderColor = '#93C5FD'; // Back to blue
                currentInput = "";
                updateInputDisplay();
            }, 600);
        }

        function updateUI() {
            scoreDisplay.innerText = score;
            levelDisplay.innerText = level;
        }

        function showFeedback(isCorrect) {
            const overlay = document.getElementById('feedback-overlay');
            const content = document.getElementById('feedback-content');
            const icon = document.getElementById('feedback-icon');
            const text = document.getElementById('feedback-text');

            overlay.style.opacity = '1';
            content.style.transform = 'scale(1)';
            
            if (isCorrect) {
                content.classList.remove('border-red-500');
                content.classList.add('border-green-500');
                icon.innerText = 'üéâ';
                text.innerText = 'Awesome!';
                text.classList.add('text-green-600');
                text.classList.remove('text-red-600');
            } else {
                content.classList.remove('border-green-500');
                content.classList.add('border-red-500');
                icon.innerText = 'ü§î';
                text.innerText = 'Try Again!';
                text.classList.add('text-red-600');
                text.classList.remove('text-green-600');
            }

            setTimeout(() => {
                overlay.style.opacity = '0';
                content.style.transform = 'scale(0)';
            }, 1200);
        }

        // --- FX ---

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = -10 + 'px';
                conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                conf.style.animationDuration = Math.random() * 2 + 1 + 's';
                document.body.appendChild(conf);
                
                setTimeout(() => conf.remove(), 3000);
            }
        }

        function playSound(type) {
            // Simple synth sounds to avoid external asset dependencies
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(880, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            }
        }

        // Initial Layout
        setTimeout(resizeCanvas, 100);
    </script>
</body>
</html>
